(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{1591:function(s,a,t){s.exports=t.p+"assets/img/image-20241121220945881.0c001abc.webp"},1592:function(s,a,t){s.exports=t.p+"assets/img/Master_Slave_Replication2.fabcecfb.webp"},1593:function(s,a,t){s.exports=t.p+"assets/img/Master_Slave_Replication_Process1.7ffc69ed.webp"},1594:function(s,a,t){s.exports=t.p+"assets/img/Master_Slave_Replication_Process2.fc1c3a9a.webp"},1595:function(s,a,t){s.exports=t.p+"assets/img/image-20241202211244895.d71575f5.webp"},1596:function(s,a){s.exports="data:image/webp;base64,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"},1597:function(s,a,t){s.exports=t.p+"assets/img/image-20241202222315789.6f7336a0.webp"},1598:function(s,a,t){s.exports=t.p+"assets/img/image-20241202213125944.1316f409.webp"},1599:function(s,a,t){s.exports=t.p+"assets/img/image-20241202214839164.20e7e9d5.webp"},1600:function(s,a,t){s.exports=t.p+"assets/img/image-20241202215805941.d71a6622.webp"},1601:function(s,a,t){s.exports=t.p+"assets/img/image-20241202215856411.866b7024.webp"},1602:function(s,a,t){s.exports=t.p+"assets/img/image-20241202215927317.7f154465.webp"},1603:function(s,a,t){s.exports=t.p+"assets/img/image-20241202220021079.3e5050d1.webp"},2147:function(s,a,t){"use strict";t.r(a);var e=t(15),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"第-18-章-主从复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第-18-章-主从复制"}},[s._v("#")]),s._v(" 第 18 章 主从复制")]),s._v(" "),a("h2",{attrs:{id:"_1-主从复制概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-主从复制概述"}},[s._v("#")]),s._v(" 1. 主从复制概述")]),s._v(" "),a("h3",{attrs:{id:"_1-1-如何提升数据库并发能力"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-如何提升数据库并发能力"}},[s._v("#")]),s._v(" 1.1 如何提升数据库并发能力")]),s._v(" "),a("p",[s._v("在实际工作中常常将"),a("code",[s._v("Redis")]),s._v("作为缓存与"),a("code",[s._v("MySQL")]),s._v("配合来使用，当有请求的时候，首先会从缓存中进行查找，如果存在就直接取出。如果不存在再访问数据库，这样就"),a("code",[s._v("提升了读取的效率")]),s._v("，也减少了对后端数据库的"),a("code",[s._v("访问压力")]),s._v(" 。Redis 的缓存架构是"),a("code",[s._v("高并发架构")]),s._v("中非常重要的一环。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1591),alt:"image-20241121220945881"}})]),s._v(" "),a("p",[s._v("此外，一般应用对数据库而言都是“"),a("code",[s._v("读多写少")]),s._v("”，也就说对数据库读取数据的压力比较大，有一个思路就是采用数据库集群的方案，做"),a("code",[s._v("主从架构")]),s._v("、进行"),a("code",[s._v("读写分离")]),s._v("，这样同样可以提升数据库的并发处理能力。但并不是所有的应用都需要对数据库进行主从架构的设置，毕竟设置架构本身是有成本的。")]),s._v(" "),a("p",[s._v("如果我们的目的在于提升数据库高并发访问的效率，那么首先考虑的是如何"),a("code",[s._v("优化 SQL 和索引")]),s._v("，这种方式简单有效；其次才是采用"),a("code",[s._v("缓存的策略")]),s._v("，比如使用 Redis 将热点数据保存在内存数据库中，提升读取的效率；最后才是对数据库采用"),a("code",[s._v("主从架构")]),s._v("，进行读写分离。")]),s._v(" "),a("p",[s._v("按照上面的方式进行优化，使用和维护的成本是由低到高的。")]),s._v(" "),a("h3",{attrs:{id:"_1-2-主从复制的作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-主从复制的作用"}},[s._v("#")]),s._v(" 1.2 主从复制的作用")]),s._v(" "),a("p",[s._v("主从同步设计不仅可以提高数据库的吞吐量，还有以下 3 个方面的作用。")]),s._v(" "),a("h4",[s._v("第 1 个作用：读写分离。")]),s._v(" "),a("p",[s._v("我们可以通过主从复制的方式来"),a("code",[s._v("同步数据")]),s._v("，然后通过读写分离提高数据库并发处理能力。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1592),alt:"Master_Slave_Replication2.webp"}})]),s._v(" "),a("p",[s._v("其中一个是 Master 主库，负责写入数据，我们称之为：写库。")]),s._v(" "),a("p",[s._v("其它都是 Slave 从库，负责读取数据，我们称之为：读库。")]),s._v(" "),a("p",[s._v("当主库进行更新的时候，会自动将数据复制到从库中，而在客户端读取数据的时候，会从从库中进行读取。")]),s._v(" "),a("p",[s._v("面对"),a("code",[s._v("读多写少")]),s._v("的需求，采用读写分离的方式，可以实现"),a("code",[s._v("更高的并发访问")]),s._v("。同时还能对从服务器进行"),a("code",[s._v("负载均衡")]),s._v("，让不同的读请求按照策略均匀地分发到不同的从服务器上，让"),a("code",[s._v("读取更加顺畅")]),s._v("。读取顺畅的另一个原因，就是 "),a("code",[s._v("减少了锁表")]),s._v("的影响，比如我们让主库负责写，当主库出现写锁的时候，不会影响到从库进行 SELECT 的读取。")]),s._v(" "),a("h4",[s._v("第 2 个作用就是数据备份。")]),s._v(" "),a("p",[s._v("通过主从复制将主库上的数据复制到了从库上，相当于是一种"),a("code",[s._v("热备份机制")]),s._v("，也就是在主库正常运行的情况下进行的备份，不会影响到服务。")]),s._v(" "),a("h4",[s._v("第 3 个作用是具有高可用性。")]),s._v(" "),a("p",[s._v("数据备份实际上是一种冗余的机制，通过这种冗余的方式可以换取数据库的高可用性，也就是当服务器出现"),a("code",[s._v("故障或宕机")]),s._v("的情况下，可以"),a("code",[s._v("切换")]),s._v("到从服务器上，保证服务的正常运行。")]),s._v(" "),a("p",[s._v("关于高可用性的程度，我们可以用一个指标衡量，即正常可用时间/全年时间。比如要达到全年 99.999%的时间都可用，就意味着系统在一年中的不可用时间不得超过"),a("code",[s._v("365*24*60*(1-99.999%)=5.256")]),s._v("分钟（含系统崩溃的时间、日常维护操作导致的停机时间等），其他时间都需要保持可用的状态。")]),s._v(" "),a("p",[s._v("实际上，更高的高可用性，意味着需要付出更高的成本代价。在现实中需要结合业务需求和成本来进行选择。")]),s._v(" "),a("h2",{attrs:{id:"_2-主从复制的原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-主从复制的原理"}},[s._v("#")]),s._v(" 2. 主从复制的原理")]),s._v(" "),a("p",[a("code",[s._v("Slave")]),s._v("会从"),a("code",[s._v("Master")]),s._v("读取"),a("code",[s._v("binlog")]),s._v("来进行数据同步。")]),s._v(" "),a("h3",{attrs:{id:"_2-1-原理剖析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-原理剖析"}},[s._v("#")]),s._v(" 2.1 原理剖析")]),s._v(" "),a("p",[a("strong",[s._v("三个线程")])]),s._v(" "),a("p",[s._v("实际上主从同步的原理就是基于 binlog 进行数据同步的。在主从复制过程中，会基于"),a("code",[s._v("3个线程")]),s._v("来操作，一个主库线程，两个从库线程。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1593),alt:"Master_Slave_Replication_Process1"}})]),s._v(" "),a("p",[a("code",[s._v("二进制日志转储线程")]),s._v("(Binlog dump thread)是一个主库线程。当从库线程连接的时候，主库可以将二进制日志发送给从库，当主库读取事件(Event)的时候，会在 Binlog 上"),a("code",[s._v("加锁")]),s._v("，读取完成之后，再将锁释放掉。")]),s._v(" "),a("p",[a("code",[s._v("从库 I/O 线程")]),s._v(" 会连接到主库，向主库发送请求更新 Binlog。这时从库的 I/O 线程就可以读取到主库的二进制日志转储线程发送的 Binlog 更新部分，并且拷贝到本地的中继日志(Relay log)。")]),s._v(" "),a("p",[a("code",[s._v("从库 SQL 线程")]),s._v(" 会读取从库中的中继日志，并且执行日志中的事件，将从库中的数据与主库保持同步。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1594),alt:"Master_Slave_Replication_Process2"}})]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("ul",[a("li",[s._v("不是所有版本的 MySQL 都默认开启服务器的二进制日志。在进行主从同步的时候，需要先检查服务器是否已经开启了二进制日志。")]),s._v(" "),a("li",[s._v("除非特殊指定，默认情况下从服务器会执行所有主服务器中保存的事件。也可以通过配置，使从服务器执行特定的事件。")])])]),s._v(" "),a("p",[a("strong",[s._v("复制三步骤")])]),s._v(" "),a("p",[s._v("步骤 1："),a("code",[s._v("Master")]),s._v("将写操作记录到二进制日志（"),a("code",[s._v("binlog")]),s._v("）。这些记录叫做"),a("strong",[s._v("二进制日志事件")]),s._v(" (binary log events);")]),s._v(" "),a("p",[s._v("步骤 2："),a("code",[s._v("Slave")]),s._v("将"),a("code",[s._v("Master")]),s._v("的 binary log events 拷贝到它的中继日志（"),a("code",[s._v("relay log")]),s._v("）；")]),s._v(" "),a("p",[s._v("步骤 3："),a("code",[s._v("Slave")]),s._v("重做中继日志中的事件，将改变应用到自己的数据库中。MySQL 复制是异步的且串行化的，而且重启后从"),a("code",[s._v("接入点")]),s._v("开始复制。")]),s._v(" "),a("p",[a("strong",[s._v("复制的问题")])]),s._v(" "),a("p",[s._v("复制的最大问题："),a("code",[s._v("延时")])]),s._v(" "),a("h3",{attrs:{id:"_2-2-复制的基本原则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-复制的基本原则"}},[s._v("#")]),s._v(" 2.2 复制的基本原则")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("每个"),a("code",[s._v("Slave")]),s._v("只有一个"),a("code",[s._v("Master")])])]),s._v(" "),a("li",[a("p",[s._v("每个"),a("code",[s._v("Slave")]),s._v("只能有一个唯一的服务器 ID")])]),s._v(" "),a("li",[a("p",[s._v("每个"),a("code",[s._v("Master")]),s._v("可以有多个"),a("code",[s._v("Slave")])])])]),s._v(" "),a("h2",{attrs:{id:"_3-一主一从架构搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-一主一从架构搭建"}},[s._v("#")]),s._v(" 3. 一主一从架构搭建")]),s._v(" "),a("p",[s._v("一台"),a("code",[s._v("主机")]),s._v("用于处理所有"),a("code",[s._v("写请求")]),s._v("，一台"),a("code",[s._v("从机")]),s._v("负责所有"),a("code",[s._v("读请求")]),s._v("，架构图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(342),alt:"master_slave_replication"}})]),s._v(" "),a("h3",{attrs:{id:"_3-1-准备工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-准备工作"}},[s._v("#")]),s._v(" 3.1 准备工作")]),s._v(" "),a("ul",[a("li",[s._v("准备 2 台 CentOS 虚拟机")]),s._v(" "),a("li",[s._v("每台虚拟机上需要安装好 MySQL （可以是 MySQL8.0 ）")])]),s._v(" "),a("p",[s._v("可以在一台 CentOS 上安装好 MySQL，进而通过克隆的方式复制出 1 台包含 MySQL 的虚拟机。")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("克隆的方式需要修改新克隆出来主机的：①"),a("code",[s._v("MAC地址")]),s._v(" ②"),a("code",[s._v("hostname")]),s._v(" ③"),a("code",[s._v("IP 地址")]),s._v(" ④"),a("code",[s._v("UUID")]),s._v("。")])]),s._v(" "),a("h4",[s._v("hostname")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/hostname\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",[s._v("IP 地址和主机的 UUID")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/sysconfig/network-scripts/ifcfg-ens33\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",[s._v("MySQLServer 的 UUID")]),s._v(" "),a("p",[s._v("此外，克隆的方式生成的虚拟机（包含 MySQL Server），则克隆的虚拟机 MySQL Server 的 UUID 相同，必须修改，否则在有些场景会报错。比如："),a("code",[s._v("show slave status\\G")]),s._v("，报如下的错误：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have\nequal MySQL server UUIDs; these UUIDs must be different for replication to work.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("修改 MySQL Server 的 UUID 方式：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /var/lib/mysql/auto.cnf\nsystemctl restart mysqld\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_3-2-主机配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-主机配置文件"}},[s._v("#")]),s._v(" 3.2 主机配置文件")]),s._v(" "),a("p",[s._v("配置文件"),a("code",[s._v("/etc/my.cnf")])]),s._v(" "),a("p",[s._v("建议 mysql 版本一致且后台以服务运行，主从所有配置项都配置在"),a("code",[s._v("[mysqld]")]),s._v("节点下，且都是小写字母。")]),s._v(" "),a("p",[s._v("具体参数配置如下：")]),s._v(" "),a("ul",[a("li",[s._v("必选")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[必须]主服务器唯一ID")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[必须]启用二进制日志,指名路径。比如：自己本地的路径/log/mysqlbin")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql8.0.25实测，此参数也是可选的")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-bin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("atguigu-bin")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("ul",[a("li",[s._v("可选")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[可选] 0（默认）表示读写（主机），1表示只读（从机）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("read-only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#设置日志文件保留的时长，单位是秒")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_expire_logs_seconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("6000")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#控制单个二进制日志大小。此参数的最大和默认值是1GB")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("max_binlog_size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("200M")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[可选]设置不要复制的数据库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog-ignore-db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("test")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[可选]设置需要复制的数据库,默认全部记录。比如：binlog-do-db=atguigu_master_slave")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog-do-db")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("需要复制的主数据库名字")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[可选]设置binlog格式")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("STATEMENT")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("strong",[a("code",[s._v("binlog-do-db")])]),s._v(" 用于指定"),a("strong",[s._v("需要写入二进制日志的数据库")]),s._v("。只有在这个选项中列出的数据库的更改才会记录到二进制日志中。")]),s._v(" "),a("p",[a("code",[s._v("binlog-do-db")]),s._v(" 的行为与当前使用的数据库有关，即 "),a("strong",[a("code",[s._v("USE")]),s._v(" 语句选择的数据库")]),s._v("。如果没有在 "),a("code",[s._v("USE")]),s._v(" 中选择目标数据库，即使影响到了 "),a("code",[s._v("binlog-do-db")]),s._v(" 指定的数据库，也不会被记录。因为 MySQL 检查的是“当前选中数据库”是否匹配 "),a("code",[s._v("binlog-do-db")]),s._v("，而不是检查 SQL 语句中是否直接涉及了相关的数据库。")]),s._v(" "),a("p",[s._v("重启后台 mysql 服务，使配置生效")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("ul",[a("li",[s._v("先搭建完主从复制，再创建数据库。")]),s._v(" "),a("li",[s._v("MySQL 主从复制起始时，从机不继承主机数据。")])])]),s._v(" "),a("h4",[s._v("排除系统库")]),s._v(" "),a("p",[s._v("主从复制，可以排除 mysql 的系统库")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replicate-ignore-db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replicate-ignore-db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("information_schema")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replicate-ignore-db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("performance_schema")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("replicate-ignore-db")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("sys")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("系统库如 "),a("code",[s._v("mysql")]),s._v("、"),a("code",[s._v("information_schema")]),s._v("、"),a("code",[s._v("performance_schema")]),s._v(" 和 "),a("code",[s._v("sys")]),s._v(" 包含了元数据、性能统计信息和系统视图，这些数据是特定于每个服务器的，在从库上同步这些数据通常是无意义的。")]),s._v(" "),a("p",[s._v("如果同步 "),a("code",[s._v("mysql")]),s._v(" 数据库，可能会导致主从库的用户、权限信息不一致或被覆盖。例如，从库的用户权限可能需要与主库不同。")]),s._v(" "),a("p",[s._v("系统库中的表（如 "),a("code",[s._v("performance_schema")]),s._v("）记录动态性能数据，这些数据更新频繁且仅对本地有意义，同步它们会增加不必要的负载。")]),s._v(" "),a("p",[a("strong",[s._v("binlog 格式设置：")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'binlog_format'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("格式 1："),a("code",[s._v("STATEMENT模式")]),s._v("（基于 SQL 语句的复制(statement-based replication, SBR)）")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("STATEMENT")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("每一条会修改数据的 sql 语句会记录到 binlog 中。"),a("strong",[s._v("这是默认的 binlog 格式。")])]),s._v(" "),a("ul",[a("li",[s._v("SBR 的优点：\n"),a("ul",[a("li",[s._v("历史悠久，技术成熟")]),s._v(" "),a("li",[s._v("不需要记录每一行的变化，减少了 binlog 日志量，文件较小")]),s._v(" "),a("li",[s._v("binlog 中包含了所有数据库更改信息，可以据此来审核数据库的安全等情况")]),s._v(" "),a("li",[s._v("binlog 可以用于实时的还原，而不仅仅用于复制")]),s._v(" "),a("li",[s._v("主从版本可以不一样，从服务器版本可以比主服务器版本高")])])]),s._v(" "),a("li",[s._v("SBR 的缺点：\n"),a("ul",[a("li",[s._v("不是所有的 UPDATE 语句都能被复制，尤其是包含不确定操作的时候")])])]),s._v(" "),a("li",[s._v("使用以下函数的语句也无法被复制：LOAD_FILE()、UUID()、USER()、FOUND_ROWS()、SYSDATE() （除非启动时启用了 --sysdate-is-now 选项）\n"),a("ul",[a("li",[s._v("INSERT ... SELECT 会产生比 RBR 更多的行级锁")]),s._v(" "),a("li",[s._v("复制需要进行全表扫描（WHERE 语句中没有使用到索引）的 UPDATE 时，需要比 RBR 请求更多的行级锁")]),s._v(" "),a("li",[s._v("对于有 AUTO_INCREMENT 字段的 InnoDB 表而言，INSERT 语句会阻塞其他 INSERT 语句")]),s._v(" "),a("li",[s._v("对于一些复杂的语句，在从服务器上的耗资源情况会更严重，而 RBR 模式下，只会对那个发生变化的记录产生影响")]),s._v(" "),a("li",[s._v("执行复杂语句如果出错的话，会消耗更多资源")]),s._v(" "),a("li",[s._v("数据表必须几乎和主服务器保持一致才行，否则可能会导致复制出错")])])])]),s._v(" "),a("p",[a("strong",[s._v("② ROW 模式（基于行的复制(row-based replication, RBR)）")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ROW")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("5.1.5 版本的 MySQL 才开始支持，不记录每条 sql 语句的上下文信息，仅记录哪条数据被修改了，修改成什\n么样了。")]),s._v(" "),a("ul",[a("li",[s._v("RBR 的优点：\n"),a("ul",[a("li",[s._v("任何情况都可以被复制，这对复制来说是最"),a("code",[s._v("安全可靠")]),s._v("的。（比如：不会出现某些特定情况下的存储过程、function、trigger 的调用和触发无法被正确复制的问题）")]),s._v(" "),a("li",[s._v("多数情况下，从服务器上的表如果有主键的话，复制就会快了很多")]),s._v(" "),a("li",[s._v("复制以下几种语句时的行锁更少：INSERT ... SELECT、包含 AUTO_INCREMENT 字段的 INSERT、没有附带条件或者并没有修改很多记录的 UPDATE 或 DELETE 语句")]),s._v(" "),a("li",[s._v("执行 INSERT，UPDATE，DELETE 语句时锁更少")]),s._v(" "),a("li",[s._v("从服务器上采用"),a("code",[s._v("多线程")]),s._v("来执行复制成为可能")])])]),s._v(" "),a("li",[s._v("RBR 的缺点：\n"),a("ul",[a("li",[s._v("binlog 大了很多")]),s._v(" "),a("li",[s._v("复杂的回滚时 binlog 中会包含大量的数据")]),s._v(" "),a("li",[s._v("主服务器上执行 UPDATE 语句时，所有发生变化的记录都会写到 binlog 中，而 SBR 只会写一次，这会导致频繁发生 binlog 的并发写问题")]),s._v(" "),a("li",[s._v("无法从 binlog 中看到都复制了些什么语句")])])])]),s._v(" "),a("p",[a("strong",[s._v("③ MIXED 模式（混合模式复制(mixed-based replication, MBR)）")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("binlog_format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("MIXED")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("从 5.1.8 版本开始，MySQL 提供了 Mixed 格式，实际上就是 Statement 与 Row 的结合。")]),s._v(" "),a("p",[s._v("在 Mixed 模式下，一般的语句修改使用 statment 格式保存 binlog。如一些函数，statement 无法完成主从复制的操作，则采用 row 格式保存 binlog。")]),s._v(" "),a("p",[s._v("MySQL 会根据执行的每一条具体的 sql 语句来区分对待记录的日志形式，也就是在 Statement 和 Row 之间选择一种。")]),s._v(" "),a("h3",{attrs:{id:"_3-3-从机配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-从机配置文件"}},[s._v("#")]),s._v(" 3.3 从机配置文件")]),s._v(" "),a("p",[s._v("要求主从所有配置项都配置在"),a("code",[s._v("my.cnf")]),s._v("的"),a("code",[s._v("[mysqld]")]),s._v("栏位下，且都是小写字母。")]),s._v(" "),a("ul",[a("li",[s._v("必选")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[必须]从服务器唯一ID")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server-id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("可选")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[可选]启用中继日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("relay-log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-relay")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("重启后台 mysql 服务，使配置生效。")]),s._v(" "),a("h3",{attrs:{id:"_3-4-主机-建立账户并授权"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-主机-建立账户并授权"}},[s._v("#")]),s._v(" 3.4 主机：建立账户并授权")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 5.5,5.7")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在主机 MySQL里执行授权主从复制的命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'从机器数据库 IP'")]),s._v(" IDENTIFIED "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'abc123'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("strong",[s._v("注意：如果使用的是 MySQL8，需要如下的方式建立账户，并授权 slave：")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" IDENTIFIED "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看用户")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" slave1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看权限")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" GRANTS "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#此语句必须执行。否则见下面。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#在my.cnf中设置default_authentication_plugin=mysql_native_password也可以")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" IDENTIFIED "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" mysql_native_password "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123456'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nflush "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("privileges")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("在从机执行 `show slave status\\G` 时报错：")]),s._v(" "),a("p",[s._v("Last_IO_Error: error connecting to master 'slave1@192.168.1.150:3306' - retry-time:60 retries:1 message: Authentication plugin 'caching_sha2_password' reported error:Authentication requires secure connection.")])]),s._v(" "),a("p",[s._v("查询 Master 的状态，并记录下 File 和 Position 的值。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" master "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 8.4版命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BINARY")]),s._v(" LOG "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------+----------+--------------+------------------+-------------------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("File")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Position "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Binlog_Do_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Binlog_Ignore_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Executed_Gtid_Set "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------+----------+--------------+------------------+-------------------+")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" binlog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("000005")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("851")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("---------------+----------+--------------+------------------+-------------------+")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("记录下 File 和 Position 的值")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("执行完此步骤后不要再操作主服务器 MySQL，防止主服务器状态值变化。")])]),s._v(" "),a("h3",{attrs:{id:"_3-5-从机-配置需要复制的主机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-从机-配置需要复制的主机"}},[s._v("#")]),s._v(" 3.5 从机：配置需要复制的主机")]),s._v(" "),a("p",[a("strong",[s._v("步骤 1")]),s._v("：从机上复制主机的命令")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("CHANGE MASTER "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v("\nMASTER_HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机的IP地址'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_USER"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机用户名'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_PASSWORD"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机用户名的密码'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_FILE"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.具体数字'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_POS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("具体值"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加此参数，可以不用更改mysql的密码插件")]),s._v("\nMASTER_SSL"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql8.0")]),s._v("\nCHANGE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REPLICATION")]),s._v(" SOURCE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v("\nSOURCE_HOST "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主库IP地址'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_PORT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 主库端口号"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_USER "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'复制用户'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_PASSWORD "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'复制用户密码'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_LOG_FILE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'日志文件名'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_LOG_POS "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" 日志文件位置"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nSOURCE_SSL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("如果报以下错误，说明以前配置过从库，从库还在运行，需要先停止")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ERROR 1198 (HY000): This operation cannot be performed with a running slave; run STOP SLAVE first\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" STOP SLAVE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("步骤 2")]),s._v("：启动 slave 同步 START SLAVE;")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#启动slave同步")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" SLAVE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#或者")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("START")]),s._v(" REPLICA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("如果报以下错误，说明存在以前的中继日志，需要先重置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("ERROR "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1872")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HY000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Slave failed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" initialize relay log info structure "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" the repository\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("可以执行如下操作，删除之前的 relay_log 信息。然后重新执行"),a("code",[s._v("CHANGE MASTER TO ...")]),s._v("语句即可。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("reset slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除SLAVE数据库的relaylog日志文件，并重新启用新的relaylog文件")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("重置从机配置")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必须先停止从机复制，才能重置从机的配置")]),s._v("\nSTOP REPLICA"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重置从机的配置")]),s._v("\nRESET SLAVE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nRESET SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[a("code",[s._v("RESET SLAVE")]),s._v(" "),a("strong",[s._v("作用")]),s._v("：清除从库的复制状态，但"),a("strong",[s._v("不删除")]),s._v(" "),a("code",[s._v("MASTER_HOST")]),s._v(" 等主库配置信息。")]),s._v(" "),a("ul",[a("li",[s._v("删除从库中保存的二进制日志的相关位置和状态。")]),s._v(" "),a("li",[s._v("但保留通过 "),a("code",[s._v("CHANGE MASTER TO")]),s._v(" 配置的主库信息（如 "),a("code",[s._v("MASTER_HOST")]),s._v("、"),a("code",[s._v("MASTER_USER")]),s._v("、"),a("code",[s._v("MASTER_PASSWORD")]),s._v(" 等）")])]),s._v(" "),a("p",[a("code",[s._v("RESET SLAVE ALL")]),s._v(" "),a("strong",[s._v("作用")]),s._v("：清除从库的复制状态，同时"),a("strong",[s._v("删除")]),s._v("所有主库配置信息。")]),s._v(" "),a("ul",[a("li",[s._v("删除从库中保存的二进制日志相关位置和状态。")]),s._v(" "),a("li",[a("strong",[s._v("清除主库配置信息")]),s._v("（"),a("code",[s._v("MASTER_HOST")]),s._v("、"),a("code",[s._v("MASTER_USER")]),s._v("、"),a("code",[s._v("MASTER_PASSWORD")]),s._v("、"),a("code",[s._v("MASTER_LOG_FILE")]),s._v(" 等）。")]),s._v(" "),a("li",[s._v("完全将从库恢复到未配置复制的初始状态。")])]),s._v(" "),a("p",[s._v("接着，查看同步状态：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("\\G"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果两个结果都是yes，说明从机同步成功")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_IO_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_SQL_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("显式如下的情况，就是不正确的。可能错误的原因有：")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_IO_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Connecting")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_SQL_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("网络不通")]),s._v(" "),a("li",[s._v("账户密码错误")]),s._v(" "),a("li",[s._v("防火墙")]),s._v(" "),a("li",[s._v("mysql 配置文件问题")]),s._v(" "),a("li",[s._v("连接服务器时语法")]),s._v(" "),a("li",[s._v("主服务器 mysql 权限")])]),s._v(" "),a("h3",{attrs:{id:"_3-6-查看主从同步情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-查看主从同步情况"}},[s._v("#")]),s._v(" 3.6 查看主从同步情况")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("\\G"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新版命令")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" REPLICA "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("\\G\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("Replica_IO_Running")]),s._v(": IO 线程是否运行。")]),s._v(" "),a("li",[a("code",[s._v("Replica_SQL_Running")]),s._v(": SQL 线程是否运行。")])]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果两个结果都是yes，说明从机同步成功")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_IO_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_SQL_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ul",[a("li",[a("p",[a("code",[s._v("Replica_IO_State")]),s._v(": IO 线程的状态，显示是否正在从主库读取 binlog。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Seconds_Behind_Master")]),s._v(": 副本与主库的延迟时间，单位为秒。")])]),s._v(" "),a("li",[a("p",[a("code",[s._v("Last_IO_Error / Last_SQL_Error")]),s._v(": 最近一次 IO 或 SQL 错误的信息。如果从机同步失败查看此参数。")])])]),s._v(" "),a("h3",{attrs:{id:"_3-7-测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-测试"}},[s._v("#")]),s._v(" 3.7 测试")]),s._v(" "),a("p",[s._v("主机新建库、新建表、insert 记录，从机复制：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DATABASE")]),s._v(" dbtest_master_slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USE")]),s._v(" dbtest_master_slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NAME "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VARCHAR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'zhang3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" test "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("@"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" VARIABLES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("LIKE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hostname'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" @"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_3-8-停止主从同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-停止主从同步"}},[s._v("#")]),s._v(" 3.8 停止主从同步")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("stop slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 新版命令")]),s._v("\nstop replica"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清除从服务器主从复制的配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 必须先停止主从复制，才能清除配置")]),s._v("\nreset replica "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("all")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除Master中所有的binglog文件，并将日志索引文件清空，重新开始所有新的日志文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (慎用) 一般不需要执行此命令")]),s._v("\nreset master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"_3-8-搭建主从架构常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-搭建主从架构常见问题"}},[s._v("#")]),s._v(" 3.8 搭建主从架构常见问题")]),s._v(" "),a("h4",{attrs:{id:"_3-8-1-caching-sha2-password"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-1-caching-sha2-password"}},[s._v("#")]),s._v(" 3.8.1 caching_sha2_password")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHOW")]),s._v(" SLAVE "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v("\\G\nLast_IO_Error: Authentication plugin "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'caching_sha2_password'")]),s._v(" reported error: Authentication requires secure connection\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("mysql8.0 以后，"),a("strong",[a("code",[s._v("caching_sha2_password")])]),s._v(" 成为了默认的用户认证插件。MySQL 主从服务器之间的用户认证也使用此插件。这种认证方式默认要求"),a("strong",[s._v("加密连接")]),s._v("（如 SSL/TLS），以提高安全性。如果未启用加密连接，从库在同步时会报此错误。")]),s._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[s._v("可能报错 Access denied for user 'slave1'@'xxx' (using password: YES)")]),s._v(" "),a("p",[s._v("这个也可能是 SSL 连接的问题")])]),s._v(" "),a("p",[a("strong",[s._v("处理方案")])]),s._v(" "),a("ul",[a("li",[s._v("方法一：在主服务器上修改认证插件")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" IDENTIFIED "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql_native_password'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'your_password'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("修改 my.cnf 文件，启动"),a("code",[s._v("mysql_native_password")]),s._v("插件")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[s._v("[mysqld]\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("mysql_native_password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("ON")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ul",[a("li",[s._v("方案二：从机"),a("code",[s._v("CHANGE MASTER")]),s._v("命令配置 SSL 连接参数")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("CHANGE MASTER "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v("\nMASTER_HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机的IP地址'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_USER"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机用户名'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_PASSWORD"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'主机用户名的密码'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_FILE"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.具体数字'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nMASTER_LOG_POS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("具体值"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nMASTER_SSL"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),a("ol",[a("li",[s._v("只要执行过一次，就算之后"),a("code",[s._v("RESET REPLICA ALL")])]),s._v(" "),a("li",[s._v("第二次 change master 就不要加 MASTER_SSL=1;了")])])]),s._v(" "),a("ul",[a("li",[s._v("禁用加密连接要求")])]),s._v(" "),a("p",[s._v("如果确定主从连接在受信任的网络环境中运行，可以禁用加密连接要求。")]),s._v(" "),a("p",[s._v("这个方法在对插件"),a("code",[s._v("caching_sha2_password")]),s._v(" 无效，默认就是"),a("code",[s._v("REQUIRE NONE")])]),s._v(" "),a("p",[s._v("但是改为"),a("code",[s._v("REQUIRE SSL")]),s._v("，必须要求从机使用"),a("code",[s._v("MASTER_SSL=1;")]),s._v("，否则报错"),a("code",[s._v("Access denied for user 'slave1'@'xxx' (using password: YES)")])]),s._v(" "),a("p",[s._v("在主库上修改用户认证的安全连接需求")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REQUIRE")]),s._v(" NONE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认的")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" slave1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以查看默认值")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ALTER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("REQUIRE")]),s._v(" SSL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("此命令不改变加密插件的类型，可以通过如下命令验证")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" host"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" plugin\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" mysql"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("user")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'slave1'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" host "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.1.91'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h4",{attrs:{id:"_3-8-2-联通性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-2-联通性问题"}},[s._v("#")]),s._v(" 3.8.2 联通性问题")]),s._v(" "),a("div",{staticClass:"language-properties line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_IO_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Connecting")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("Slave_SQL_Running")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("Yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("在从库服务器尝试手动连接主库，确认网络连通性和用户认证是否正常")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("mysql "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-P")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-u")]),s._v(" slave1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"_3-9-后续"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-后续"}},[s._v("#")]),s._v(" 3.9 后续")]),s._v(" "),a("p",[a("strong",[s._v("搭建主从复制：双主双")])]),s._v(" "),a("p",[s._v("一个主机 m1 用于处理所有写请求，它的从机 s1 和另一台主机 m2 还有它的从机 s2 负责所有读请求。当 m1 主机宕机后，m2 主机负责写请求，m1、m2 互为备机。架构图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(343),alt:"master_master_replication"}})]),s._v(" "),a("p",[a("img",{attrs:{src:t(1595),alt:"image-20241202211244895"}})]),s._v(" "),a("h2",{attrs:{id:"_4-同步数据一致性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-同步数据一致性问题"}},[s._v("#")]),s._v(" 4. 同步数据一致性问题")]),s._v(" "),a("p",[a("strong",[s._v("主从同步的要求：")])]),s._v(" "),a("ul",[a("li",[s._v("读库和写库的数据一致（最终一致）；")]),s._v(" "),a("li",[s._v("写数据必须写到写库；")]),s._v(" "),a("li",[s._v("读数据必须到读库（不一定）；")])]),s._v(" "),a("h3",{attrs:{id:"_4-1-理解主从延迟问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-理解主从延迟问题"}},[s._v("#")]),s._v(" 4.1 理解主从延迟问题")]),s._v(" "),a("p",[s._v("进行主从同步的内容是二进制日志，它是一个文件，在进行"),a("code",[s._v("网络传输")]),s._v("的过程中就一定会"),a("code",[s._v("存在主从延迟")]),s._v("（比如 500ms），这样就可能造成用户在从库上读取的数据不是最新的数据，也就是主从同步中的"),a("code",[s._v("数据不一致性")]),s._v("问题。")]),s._v(" "),a("p",[a("strong",[s._v("举例")]),s._v("：导致主从延迟的时间点主要包括以下三个:")]),s._v(" "),a("ul",[a("li",[s._v("主库 A 执行完成一个事务，写入 binlog，我们把这个时刻记为 T1;")]),s._v(" "),a("li",[s._v("之后传给从库 B，我们把从库 B 接收完这个 binlog 的时刻记为 T2;")]),s._v(" "),a("li",[s._v("从库 B 执行完成这个事务，我们把这个时刻记为 T3。")])]),s._v(" "),a("h3",{attrs:{id:"_4-2-主从延迟问题原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-主从延迟问题原因"}},[s._v("#")]),s._v(" 4.2 主从延迟问题原因")]),s._v(" "),a("p",[s._v("在网络正常的时候，日志从主库传给从库所需的时间是很短的，即 T2-T1 的值是非常小的。即，网络正常情况下，主备延迟的主要来源是备库接收完 binlog 和执行完这个事务之间的时间差。")]),s._v(" "),a("p",[a("strong",[s._v("主备延迟最直接的表现是，从库消费中继日志(relay log)的速度，比主库生产 binlog 的速度要慢")]),s._v("。造成原因：")]),s._v(" "),a("ul",[a("li",[s._v("从库的机器性能比主库要差")]),s._v(" "),a("li",[s._v("从库的压力大")]),s._v(" "),a("li",[s._v("大事务的执行")])]),s._v(" "),a("p",[a("strong",[s._v("举例 1")]),s._v("：一次性用 delete 语句删除太多数据")]),s._v(" "),a("p",[s._v("结论：后续再删除数据的时候，要控制每个事务删除的数据量，分成多次删除。")]),s._v(" "),a("p",[a("strong",[s._v("举例 2")]),s._v("：一次性用 insert...select 插入太多数据")]),s._v(" "),a("p",[a("strong",[s._v("举例 3")]),s._v("： 大表 DDL")]),s._v(" "),a("p",[s._v("比如在主库对一张 500W 的表添加一个字段耗费了 10 分钟，那么从节点上也会耗费 10 分钟。")]),s._v(" "),a("h3",{attrs:{id:"_4-3-如何减少主从延迟"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-如何减少主从延迟"}},[s._v("#")]),s._v(" 4.3 如何减少主从延迟")]),s._v(" "),a("p",[s._v("若想要减少主从延迟的时间，可以采取下面的办法：")]),s._v(" "),a("ol",[a("li",[s._v("降低多线程大事务并发的概率，优化业务逻辑")]),s._v(" "),a("li",[s._v("优化 SQL，避免慢 SQL，"),a("code",[s._v("减少批量操作")]),s._v("，建议写脚本以 update-sleep 这样的形式完成。")]),s._v(" "),a("li",[a("code",[s._v("提高从库机器的配置")]),s._v("，减少主库写 binlog 和从库读 binlog 的效率差。")]),s._v(" "),a("li",[s._v("尽量采用"),a("code",[s._v("短的链路")]),s._v("，也就是主库和从库服务器的距离尽量要短，提升端口带宽，减少 binlog 传输的网络延时。")]),s._v(" "),a("li",[s._v("实时性要求的业务读强制走主库，从库只做灾备，备份。")])]),s._v(" "),a("h3",{attrs:{id:"_4-4-如何解决一致性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-如何解决一致性问题"}},[s._v("#")]),s._v(" 4.4 如何解决一致性问题")]),s._v(" "),a("p",[s._v("如果操作的数据存储在同一个数据库中，那么对数据进行更新的时候，可以对记录加写锁，这样在读取的时候就不会发生数据不一致的情况。但这时从库的作用就是"),a("code",[s._v("备份")]),s._v("，并没有起到"),a("code",[s._v("读写分离")]),s._v("，分担主库"),a("code",[s._v("读压力")]),s._v("的作用。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1596),alt:"image-20241202222315787.webp"}})]),s._v(" "),a("p",[s._v("读写分离情况下，解决主从同步中数据不一致的问题，就是解决主从之间"),a("code",[s._v("数据复制方式")]),s._v("的问题，如果按照数据一致性"),a("code",[s._v("从弱到强")]),s._v("来进行划分，有以下 3 种复制方式。")]),s._v(" "),a("h4",{attrs:{id:"方法-1-异步复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法-1-异步复制"}},[s._v("#")]),s._v(" 方法 1：异步复制")]),s._v(" "),a("p",[s._v("异步模式就是客户端提交 COMMIT 之后不需要等从库返回任何结果，而是直接将结果返回给客户端，这样做的好处是不会影响主库写的效率，但可能会存在主库宕机，而 Binlog 还没有同步到从库的情况，也就是此时的主库和从库数据不一致。这时候从从库中选择一个作为新主，那么新主则可能缺少原来主服务器中已提交的事务。所以，这种复制模式下的数据一致性是最弱的。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1597),alt:"image-20241202222315789"}})]),s._v(" "),a("h4",{attrs:{id:"方法-2-半同步复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法-2-半同步复制"}},[s._v("#")]),s._v(" 方法 2：半同步复制")]),s._v(" "),a("p",[s._v("MySQL5.5 版本之后开始支持半同步复制的方式。原理是在客户端提交 COMMIT 之后不直接将结果返回给客户端，而是等待至少有一个从库接收到了 Binlog，并且写入到中继日志中，再返回给客户端。")]),s._v(" "),a("p",[s._v("这样做的好处就是提高了数据的一致性，当然相比于异步复制来说，至少多增加了一个网络连接的延迟，降低了主库写的效率。")]),s._v(" "),a("p",[s._v("在 MySQL5.7 版本中还增加了一个"),a("code",[s._v("rpl_semi_sync_master_wait_for_slave_count")]),s._v("参数，可以对应答的从库数量进行设置，默认为"),a("code",[s._v("1")]),s._v("，也就是说只要有 1 个从库进行了响应，就可以返回给客户端。如果将这个参数调大，可以提升数据一致性的强度，但也会增加主库等待从库响应的时间。【以时间换取一致性】")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1598),alt:"image-20241202213125944"}})]),s._v(" "),a("h4",{attrs:{id:"方法-3-组复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法-3-组复制"}},[s._v("#")]),s._v(" 方法 3：组复制")]),s._v(" "),a("p",[s._v("异步复制和半同步复制都无法最终保证数据的一致性问题，半同步复制是通过判断从库响应的个数来决定是否返回给客户端，虽然数据一致性相比于异步复制有提升，但仍然无法满足对数据一致性要求高的场景，比如金融领域。MGR 很好地弥补了这两种复制模式的不足。")]),s._v(" "),a("p",[s._v("组复制技术，简称 MGR(MySQL Group Replication)。是 MySQL 在 5.7.17 版本中推出的一种新的数据复制技术，这种复制技术是基于 Paxos 协议的状态机复制。")]),s._v(" "),a("p",[a("strong",[s._v("MGR 是如何工作的")])]),s._v(" "),a("p",[s._v("首先我们将多个节点共同组成一个复制组，在"),a("code",[s._v("执行读写(RW)事务")]),s._v("的时候，需要通过一致性协议层 （Consensus 层）的同意，也就是读写事务想要进行提交，必须要经过组里“大多数人”（对应 Node 节点）的同意，大多数指的是同意的节点数量需要大于(N/2+1)，这样才可以进行提交，而不是原发起方一个说了算。而针对"),a("code",[s._v("只读(RO)")]),s._v("事务则不需要经过组内同意，直接 COMMIT 即可。")]),s._v(" "),a("p",[s._v("在一个复制组内有多个节点组成，它们各自维护了自己的数据副本，并且在一致性协议层实现了原子消息和全局有序消息，从而保证组内数据的一致性。")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1599),alt:"image-20241202214839164"}})]),s._v(" "),a("p",[s._v("MGR 将 MySQL 带入了数据强一致性的时代，是一个划时代的创新，其中一个重要的原因就是 MGR 是基于 Paxos 协议的。Paxos 算法是由 2013 年的图灵奖获得者 Leslie Lamport 于 1990 年提出的，有关这个算法的决策机制可以搜一下。事实上，Paxos 算法提出来之后就作为"),a("code",[s._v("分布式一致性算法")]),s._v("被广泛应用，比如 Apache 的 ZooKeeper 也是基于 Paxos 实现的。")]),s._v(" "),a("h2",{attrs:{id:"_5-知识延伸"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-知识延伸"}},[s._v("#")]),s._v(" 5. 知识延伸")]),s._v(" "),a("p",[s._v("在主从架构的配置中，如果想要采取读写分离的策略，我们可以"),a("code",[s._v("自己编写程序")]),s._v("，也可以通过"),a("code",[s._v("第三方的中间件")]),s._v("来实现。")]),s._v(" "),a("ul",[a("li",[s._v("自己编写程序的好处就在于比较自主，我们可以自己判断哪些查询在从库上来执行，针对实时性要求高的需求，我们还可以考虑哪些查询可以在主库上执行。同时，程序直接连接数据库，减少了中间件层，相当于减少了性能损耗。")]),s._v(" "),a("li",[s._v("采用中间件的方法有很明显的优势，"),a("code",[s._v("功能强大")]),s._v("，"),a("code",[s._v("使用简单")]),s._v("。但因为在客户端和数据库之间增加了中间件层会有一些性能损耗，同时商业中间件也是有使用成本的。我们也可以考虑采取一些优秀的开源工具。")])]),s._v(" "),a("p",[a("img",{attrs:{src:t(1600),alt:"image-20241202215805941"}})]),s._v(" "),a("p",[s._v("① "),a("code",[s._v("Cobar")]),s._v(" 属于阿里 B2B 事业群，始于 2008 年，在阿里服役 3 年多，接管 3000+个 MySQL 数据库的\nschema,集群日处理在线 SQL 请求 50 亿次以上。由于 Cobar 发起人的离职，Cobar 停止维护。")]),s._v(" "),a("p",[s._v("② "),a("code",[s._v("Mycat")]),s._v(" 是开源社区在阿里 cobar 基础上进行二次开发，解决了 cobar 存在的问题，并且加入了许多新的功能在其中。青出于蓝而胜于蓝")]),s._v(" "),a("p",[s._v("③ "),a("code",[s._v("OneProxy")]),s._v(" 基于 MySQL 官方的 proxy 思想利用 c 语言进行开发的，OneProxy 是一款商业收费的中间件。舍弃了一些功能，专注在性能和稳定性上。")]),s._v(" "),a("p",[s._v("④ "),a("code",[s._v("kingshard")]),s._v(" 由小团队用 go 语言开发，还需要发展，需要不断完善。")]),s._v(" "),a("p",[s._v("⑤ "),a("code",[s._v("Vitess")]),s._v(" 是 Youtube 生产在使用，架构很复杂。不支持 MySQL 原生协议，使用需要大量改造成本。")]),s._v(" "),a("p",[s._v("⑥ "),a("code",[s._v("Atlas")]),s._v(" 是 360 团队基于 mysql proxy 改写，功能还需完善，高并发下不稳定。")]),s._v(" "),a("p",[s._v("⑦ "),a("code",[s._v("MaxScale")]),s._v(" 是 mariadb（MySQL 原作者维护的一个版本）研发的中间件")]),s._v(" "),a("p",[s._v("⑧ "),a("code",[s._v("MySQLRoute")]),s._v(" 是 MySQL 官方 Oracle 公司发布的中间件")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1601),alt:"image-20241202215856411.webp"}})]),s._v(" "),a("p",[a("img",{attrs:{src:t(1602),alt:"image-20241202215927317.webp"}})]),s._v(" "),a("p",[s._v("主备切换：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(1603),alt:"image-20241202220021079"}})]),s._v(" "),a("ul",[a("li",[s._v("主动切换")]),s._v(" "),a("li",[s._v("被动切换")]),s._v(" "),a("li",[s._v("如何判断主库出问题了？如何解决过程中的数据不一致性问题？")])])])}),[],!1,null,null,null);a.default=n.exports},342:function(s,a,t){s.exports=t.p+"assets/img/master_slave_replication.ebe86956.webp"},343:function(s,a,t){s.exports=t.p+"assets/img/master_master_replication.7f028850.webp"}}]);